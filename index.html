<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Language Live Editor + Gemini AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeMirror 5 (Editor Library) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <!-- Languages Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script> <!-- Java, C++, Swift-like -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/swift/swift.min.js"></script>
    
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchtags.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.js"></script>

    <!-- Split.js (Resizable Panes) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.5/split.min.js"></script>
    
    <!-- Prettier (Formatter) -->
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script> <!-- For JS/Java/Python formatting support -->

    <!-- Pyodide (Python in Browser) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">

    <!-- Markdown Parser for AI Response -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #1e1e1e; color: #e0e0e0; overflow: hidden; }
        .code-font { font-family: 'Source Code Pro', monospace; }
        
        /* Layout & Split.js Handles */
        .gutter {
            background-color: #333;
            background-repeat: no-repeat;
            background-position: 50%;
            transition: background-color 0.2s;
        }
        .gutter:hover { background-color: #4a9eff; }
        .gutter.gutter-horizontal { cursor: col-resize; }
        .gutter.gutter-vertical { cursor: row-resize; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* CodeMirror Customization */
        .CodeMirror { height: 100%; font-family: 'Source Code Pro', monospace; font-size: 14px; line-height: 1.5; }
        .cm-s-material-darker.CodeMirror { background-color: #1e1e1e; }
        
        /* Search Highlight Styling (High Contrast) */
        .search-highlight {
            background-color: #ffff00 !important; /* Bright Yellow */
            color: #000000 !important; /* Black Text */
            font-weight: bold;
            border: 1px solid #eab308;
        }

        .cm-searching {
            background-color: #ffff00 !important;
            color: #000 !important;
        }

        /* Console Output Styling (for Python) */
        #consoleOutput {
            font-family: 'Source Code Pro', monospace;
            white-space: pre-wrap;
            color: #00ff00;
            background-color: #000;
            padding: 1rem;
            height: 100%;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }

        /* Mobile Device Frame (for iOS/Android) */
        .mobile-wrapper {
            display: none; /* Hidden by default */
            height: 100%;
            width: 100%;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            overflow: hidden;
        }
        .mobile-device {
            width: 300px;
            height: 600px;
            border: 12px solid #333;
            border-radius: 30px;
            background: #fff;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .mobile-notch {
            height: 20px;
            background: #333;
            width: 50%;
            margin: 0 auto;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            position: absolute;
            top: 0;
            left: 25%;
            z-index: 10;
        }
        .mobile-screen {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: #333;
            font-family: sans-serif;
        }
        .mobile-screen h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .mobile-screen button { 
            width: 100%; padding: 10px; background: #007aff; color: white; border-radius: 8px; margin-top: 10px;
        }

        /* AI Chat Window - Expanded Size */
        #aiChatContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 500px; /* Increased Width */
            height: 700px; /* Increased Height */
            background-color: #252526;
            border: 1px solid #444;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }
        #aiChatHeader {
            background-color: #333;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            border-bottom: 1px solid #444;
        }
        #aiChatMessages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #1e1e1e;
            font-size: 15px; /* Increased Font Size */
            line-height: 1.6;
        }
        #aiChatInputArea {
            padding: 10px;
            background-color: #252526;
            border-top: 1px solid #444;
            display: flex;
            gap: 5px;
        }
        .ai-msg { margin-bottom: 15px; padding: 10px 14px; border-radius: 8px; max-width: 90%; word-wrap: break-word; }
        .ai-msg.user { background-color: #0e639c; color: white; align-self: flex-end; margin-left: auto; }
        .ai-msg.bot { background-color: #333; color: #e0e0e0; align-self: flex-start; border: 1px solid #444; width: 100%; max-width: 100%; }
        .ai-msg.bot p { margin-bottom: 0.5rem; }
        
        /* Code Block Styling in Chat */
        .ai-msg.bot pre { 
            background: #111; 
            padding: 0; 
            border-radius: 4px; 
            overflow-x: auto; 
            margin-top: 10px; 
            position: relative;
            border: 1px solid #444;
        }
        .ai-msg.bot code { font-family: 'Source Code Pro', monospace; font-size: 13px; display: block; padding: 12px; }
        
        /* Code Block Header & Buttons */
        .code-block-header {
            display: flex;
            justify-content: flex-end;
            background: #2d2d2d;
            padding: 4px 8px;
            border-bottom: 1px solid #444;
            gap: 8px;
        }
        .code-btn {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            color: #ddd;
            background: #444;
            border: none;
        }
        .code-btn:hover { background: #555; }
        .code-btn.apply { background: #2563eb; color: white; }
        .code-btn.apply:hover { background: #1d4ed8; }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .split { width: 100% !important; height: auto !important; }
            #main-split, #left-split, #right-split { display: flex; flex-direction: column; }
            #aiChatContainer { width: 90%; right: 5%; bottom: 5%; height: 70%; }
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Header / Toolbar -->
    <header class="bg-gray-800 border-b border-gray-700 p-2 flex flex-col gap-2 shrink-0 transition-all duration-300">
        <!-- Top Row: Controls -->
        <div class="flex flex-wrap items-center gap-2 justify-between w-full">
            <div class="flex items-center gap-2">
                <h1 class="text-lg font-bold text-blue-400 mr-2">Multi-Lang Studio</h1>
                
                <!-- Language Selector -->
                <select id="langSelect" onchange="changeLanguage()" class="bg-gray-700 text-white text-sm rounded px-2 py-1.5 border border-gray-600 focus:outline-none hover:bg-gray-600">
                    <option value="html">HTML5 / JS</option>
                    <option value="python">Python</option>
                    <option value="ios">iOS (Swift)</option>
                    <option value="android">Android (Kotlin)</option>
                </select>

                <!-- File Attachment Button -->
                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileUpload(this)">
                <button onclick="document.getElementById('fileInput').click()" class="px-3 py-1.5 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded shadow transition flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    íŒŒì¼ ì²¨ë¶€
                </button>

                <!-- AI Helper Button -->
                <button onclick="toggleAIChat()" class="px-3 py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white text-sm rounded shadow transition flex items-center gap-1 font-bold">
                    <span>Gemini</span>
                </button>

                <div class="h-6 w-px bg-gray-600 mx-1"></div>

                <button onclick="clearEditor()" class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-sm rounded shadow transition">ì´ˆê¸°í™”</button>
                <button onclick="saveFile()" class="px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-sm rounded shadow transition">ì €ì¥</button>
                <button onclick="formatCode()" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white text-sm rounded shadow transition">Prettier ì •ë ¬</button>
                
                <div class="h-6 w-px bg-gray-600 mx-1"></div>
                
                <button onclick="editor1.undo()" class="px-2 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded" title="Undo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg></button>
                <button onclick="editor1.redo()" class="px-2 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded" title="Redo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg></button>
            </div>

            <div class="flex items-center gap-2 bg-gray-700 rounded px-2 py-1">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." class="bg-transparent border-none text-white text-sm focus:outline-none w-32 md:w-48" onkeydown="if(event.key==='Enter') performSearch(true)">
                <span id="searchCount" class="text-xs text-gray-400 w-12 text-center">0/0</span>
                <button onclick="performSearch(false)" class="text-gray-300 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
                <button onclick="performSearch(true)" class="text-gray-300 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>
                <button onclick="performSearch(true)" class="ml-1 text-blue-400 hover:text-blue-300 font-bold">ê²€ìƒ‰</button>
            </div>
        </div>
        
        <!-- Bottom Row: Attached Files List -->
        <div id="attachedFilesList" class="flex flex-wrap gap-2 w-full min-h-[0px] empty:hidden transition-all duration-300" style="max-height: 80px; overflow-y: auto;">
            <!-- Files will be added here dynamically -->
        </div>
    </header>

    <!-- AI Chat Window -->
    <div id="aiChatContainer">
        <div id="aiChatHeader">
            <span class="font-bold text-white flex items-center gap-2">Gemini</span>
            <button onclick="toggleAIChat()" class="text-gray-400 hover:text-white">âœ•</button>
        </div>
        
        <!-- API Key Input Section -->
        <div id="apiKeySection" class="p-4 bg-[#2d2d2d] border-b border-gray-700">
            <p class="text-xs text-gray-400 mb-2">Google Gemini API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <div class="flex gap-2">
                <input type="password" id="geminiApiKey" placeholder="API Key ì…ë ¥" class="flex-1 bg-gray-800 text-white text-sm px-2 py-1 rounded border border-gray-600 focus:outline-none">
                <button onclick="saveApiKey()" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1 rounded">ì €ì¥</button>
            </div>
        </div>

        <div id="aiChatMessages" class="flex flex-col">
            <div class="ai-msg bot">
                ì•ˆë…•í•˜ì„¸ìš”! ì½”ë“œë¥¼ ì‘ì„±í•˜ë‹¤ê°€ ë§‰íˆëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”. í˜„ì¬ ì‘ì„± ì¤‘ì¸ ì½”ë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•´ ë“œë¦´ê²Œìš”. ğŸ˜Š
            </div>
        </div>
        
        <div id="aiChatInputArea">
            <textarea id="aiUserQuery" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (Shift+Enter ì¤„ë°”ê¿ˆ)" class="flex-1 bg-gray-800 text-white text-sm px-2 py-1 rounded border border-gray-600 focus:outline-none resize-none h-12"></textarea>
            <button onclick="sendMessageToAI()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div id="main-container" class="flex-1 flex overflow-hidden">
        
        <!-- Left Column -->
        <div id="left-col" class="flex flex-col h-full bg-[#1e1e1e]">
            
            <!-- Pane 1: Editor -->
            <div id="pane1" class="relative flex flex-col h-full">
                <div class="bg-gray-800 text-xs px-2 py-1 text-gray-400 font-mono border-b border-gray-700 flex justify-between">
                    <span id="editor-title">EDITOR (HTML/CSS/JS)</span>
                    <span id="cursor-pos">Line 1, Col 1</span>
                </div>
                <div class="flex-1 overflow-hidden relative">
                    <textarea id="codeEditor"></textarea>
                </div>
            </div>

            <!-- Pane 3: Block Editor -->
            <div id="pane3" class="relative flex flex-col h-full bg-[#252526] border-t border-gray-700">
                <div class="bg-gray-800 text-xs px-2 py-1 text-gray-400 font-mono border-b border-gray-700 flex justify-between items-center">
                    <span>SELECTED BLOCK EDITOR</span>
                    <div class="flex gap-2">
                        <button onclick="testBlock()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-2 rounded text-[10px]">ì‘ë™ (í…ŒìŠ¤íŠ¸)</button>
                        <button onclick="applyBlock()" class="bg-blue-600 hover:bg-blue-500 text-white px-2 rounded text-[10px]">ì ìš© (ì €ì¥)</button>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden">
                    <textarea id="blockEditor"></textarea>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div id="right-col" class="flex flex-col h-full bg-white">
            
            <!-- Pane 2: Preview -->
            <div id="pane2" class="relative flex flex-col h-full bg-white">
                <div class="bg-gray-200 text-xs px-2 py-1 text-gray-600 font-mono border-b border-gray-300 flex justify-between">
                    <span>PREVIEW / OUTPUT</span>
                    <span id="status-indicator" class="text-xs font-bold text-gray-500">Ready</span>
                </div>
                
                <!-- 1. HTML Iframe -->
                <iframe id="previewFrame" class="w-full h-full border-none bg-white block"></iframe>
                
                <!-- 2. Python Console Output -->
                <div id="consoleOutput" class="hidden"></div>

                <!-- 3. Mobile Simulator (iOS/Android) -->
                <div id="mobilePreview" class="mobile-wrapper hidden">
                    <div class="mobile-device">
                        <div class="mobile-notch"></div>
                        <div class="mobile-screen" id="mobileScreenContent">
                            <!-- App content simulated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pane 4: Explanation -->
            <div id="pane4" class="relative flex flex-col h-full bg-gray-50 border-t border-gray-300">
                <div class="bg-gray-200 text-xs px-2 py-1 text-gray-600 font-mono border-b border-gray-300">
                    SYNTAX GUIDE
                </div>
                <div id="explanationContent" class="p-4 text-sm text-gray-800 overflow-y-auto leading-relaxed">
                    ì—ë””í„°ì—ì„œ ì½”ë“œë¥¼ ì„ íƒí•˜ë©´ ê´€ë ¨ ë¬¸ë²• ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transform translate-y-20 transition-transform duration-300 z-50"></div>

    <script>
        // --- 1. Initialization ---
        
        // Language Default Codes
        const templates = {
            html: `<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; }
        h1 { color: #3498db; }
        button { padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>HTML5 Preview</h1>
    <p>ì›¹ ì½”ë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì •í•´ë³´ì„¸ìš”.</p>
    <button onclick="alert('Hello!')">Click Me</button>
</body>
</html>`,
            python: `# Python 3.10+ í™˜ê²½ì…ë‹ˆë‹¤.
# ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹¤í–‰ ê²°ê³¼ê°€ ì˜¤ë¥¸ìª½ ì½˜ì†”ì— ì¶œë ¥ë©ë‹ˆë‹¤.

def greet(name):
    return f"Hello, {name}!"

print("--- Python Execution Start ---")
print(greet("Developer"))

# ë¦¬ìŠ¤íŠ¸ ì»´í”„ë¦¬í—¨ì…˜ ì˜ˆì œ
numbers = [1, 2, 3, 4, 5]
squares = [n**2 for n in numbers]
print(f"Squares: {squares}")

import random
print(f"Random Number: {random.randint(1, 100)}")
`,
            ios: `// Swift UI Preview Simulation
// ì‹¤ì œ ì»´íŒŒì¼ì€ ë˜ì§€ ì•Šì§€ë§Œ, ì•± ë ˆì´ì•„ì›ƒì„ í™•ì¸í•˜ì„¸ìš”.

import SwiftUI

struct ContentView: View {
    var body: some View {
        VStack {
            Image(systemName: "globe")
                .imageScale(.large)
                .foregroundColor(.accentColor)
            Text("Hello, iOS!")
                .font(.title)
                .padding()
            
            Button(action: {
                print("Button tapped!")
            }) {
                Text("Tap Me")
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(10)
            }
        }
    }
}`,
            android: `// Android Kotlin Preview Simulation
// ì‹¤ì œ ì»´íŒŒì¼ì€ ë˜ì§€ ì•Šì§€ë§Œ, ì•± ë ˆì´ì•„ì›ƒì„ í™•ì¸í•˜ì„¸ìš”.

package com.example.myapp

import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity
import android.widget.Toast

class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        val message = "Hello, Android!"
        println(message)
        
        // Button Logic
        button.setOnClickListener {
            Toast.makeText(this, "Clicked!", Toast.LENGTH_SHORT).show()
        }
    }
}`
        };

        // --- Expanded Syntax Database (UNCHANGED) ---
        const syntaxData = {
            // HTML / CSS / JS (Existing)
            "default": { title: "Code Guide", desc: "ì½”ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸í•œ ë¬¸ë²• ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.", usage: "ë§ˆìš°ìŠ¤ë¡œ ì—ë””í„°ì˜ íŠ¹ì • ë¶€ë¶„ì„ í´ë¦­í•˜ì„¸ìš”.", example: "" },
            "div": { title: "<div> (Division)", desc: "ì›¹ í˜ì´ì§€ì˜ ì„¹ì…˜ì´ë‚˜ êµ¬ì—­ì„ ë‚˜ëˆŒ ë•Œ ì‚¬ìš©í•˜ëŠ” ë¸”ë¡ ë ˆë²¨ ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤.", usage: `<div class="í´ë˜ìŠ¤ëª…">...</div>`, attr: ["class, id: ìŠ¤íƒ€ì¼ ì§€ì •"] },
            "h1": { title: "<h1> ~ <h6> (Heading)", desc: "ë¬¸ì„œì˜ ì œëª©ì„ ì •ì˜í•©ë‹ˆë‹¤. h1ì´ ê°€ì¥ í½ë‹ˆë‹¤.", usage: `<h1>Title</h1>`, attr: [] },
            "p": { title: "<p> (Paragraph)", desc: "ë¬¸ë‹¨(Paragraph)ì„ ì •ì˜í•©ë‹ˆë‹¤.", usage: `<p>ë‚´ìš©</p>`, attr: [] },
            "button": { title: "<button>", desc: "í´ë¦­ ê°€ëŠ¥í•œ ë²„íŠ¼ì„ ìƒì„±í•©ë‹ˆë‹¤.", usage: `<button>í´ë¦­</button>`, attr: ["onclick: ì´ë²¤íŠ¸"] },
            "input": { title: "<input>", desc: "ì‚¬ìš©ì ì…ë ¥ì„ ë°›ëŠ” ìš”ì†Œì…ë‹ˆë‹¤.", usage: `<input type="text">`, attr: ["type, placeholder"] },
            "img": { title: "<img>", desc: "ì´ë¯¸ì§€ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.", usage: `<img src="..." alt="...">`, attr: ["src: ê²½ë¡œ", "alt: ì„¤ëª…"] },
            "script": { title: "<script>", desc: "JS ì½”ë“œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.", usage: `<script>...<\/script>`, attr: [] },
            "style": { title: "<style>", desc: "CSS ìŠ¤íƒ€ì¼ì„ ì •ì˜í•©ë‹ˆë‹¤.", usage: `<style>...</style>`, attr: [] },
            "function": { title: "function (JS)", desc: "ìë°”ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ ì •ì˜ì…ë‹ˆë‹¤.", usage: `function name() { ... }`, attr: [] },
            "var": { title: "Variable (JS)", desc: "ë³€ìˆ˜ ì„ ì–¸ (var, let, const)", usage: `let x = 10;`, attr: [] },
            
            // Python Keys
            "python_def": { title: "def (í•¨ìˆ˜ ì •ì˜)", desc: "í•¨ìˆ˜(Function)ë¥¼ ì •ì˜í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í‚¤ì›Œë“œì…ë‹ˆë‹¤.", usage: "def í•¨ìˆ˜ëª…(ë§¤ê°œë³€ìˆ˜):\n    ì‹¤í–‰í•  ì½”ë“œ\n    return ê°’", attr: ["ë“¤ì—¬ì“°ê¸°(Indentation) í•„ìˆ˜", "return: ê°’ ë°˜í™˜"] },
            "python_print": { title: "print()", desc: "ì½˜ì†”ì— ê°’ì„ ì¶œë ¥í•˜ëŠ” ë‚´ì¥ í•¨ìˆ˜ì…ë‹ˆë‹¤. ë””ë²„ê¹…ì´ë‚˜ ê²°ê³¼ í™•ì¸ì— ì‚¬ìš©ë©ë‹ˆë‹¤.", usage: "print('Hello World')\nprint(ë³€ìˆ˜ëª…)", attr: ["end: ì¤„ë°”ê¿ˆ ì œì–´", "sep: êµ¬ë¶„ì ì§€ì •"] },
            "python_import": { title: "import", desc: "ì™¸ë¶€ ëª¨ë“ˆì´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í˜„ì¬ ì½”ë“œë¡œ ë¶ˆëŸ¬ì˜¬ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.", usage: "import math\nfrom random import randint", attr: [] },
            "python_if": { title: "if (ì¡°ê±´ë¬¸)", desc: "ì¡°ê±´ì´ ì°¸(True)ì¼ ë•Œ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. elif, elseì™€ í•¨ê»˜ ì‚¬ìš©ë©ë‹ˆë‹¤.", usage: "if ì¡°ê±´:\n    ì‹¤í–‰ ì½”ë“œ\nelse:\n    ì‹¤í–‰ ì½”ë“œ", attr: [] },
            "python_for": { title: "for (ë°˜ë³µë¬¸)", desc: "ë¦¬ìŠ¤íŠ¸ë‚˜ ë²”ìœ„(range)ì˜ ìš”ì†Œë¥¼ ìˆœíšŒí•˜ë©° ì½”ë“œë¥¼ ë°˜ë³µ ì‹¤í–‰í•©ë‹ˆë‹¤.", usage: "for i in range(10):\n    print(i)", attr: [] },

            // iOS (Swift) Keys
            "swift_struct": { title: "struct (êµ¬ì¡°ì²´)", desc: "SwiftUIì—ì„œ Viewë¥¼ êµ¬ì„±í•˜ëŠ” ê¸°ë³¸ ë‹¨ìœ„ì…ë‹ˆë‹¤. ê°’ íƒ€ì…(Value Type)ì…ë‹ˆë‹¤.", usage: "struct MyView: View {\n    var body: some View { ... }\n}", attr: ["View í”„ë¡œí† ì½œ ì±„íƒ í•„ìš”"] },
            "swift_var": { title: "var (ë³€ìˆ˜)", desc: "ê°’ì„ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ë³€ìˆ˜ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤.", usage: "var name = 'John'", attr: [] },
            "swift_let": { title: "let (ìƒìˆ˜)", desc: "ê°’ì„ ë³€ê²½í•  ìˆ˜ ì—†ëŠ” ìƒìˆ˜ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤. ì•ˆì „ì„±ì„ ìœ„í•´ ê¶Œì¥ë©ë‹ˆë‹¤.", usage: "let pi = 3.14", attr: [] },
            "swift_func": { title: "func (í•¨ìˆ˜)", desc: "Swiftì—ì„œ í•¨ìˆ˜ë¥¼ ì •ì˜í•˜ëŠ” í‚¤ì›Œë“œì…ë‹ˆë‹¤.", usage: "func greet(name: String) {\n    print(name)\n}", attr: [] },
            "swift_vstack": { title: "VStack", desc: "Vertical Stack. ìì‹ ë·°ë“¤ì„ ì„¸ë¡œë¡œ ë‚˜ì—´í•˜ëŠ” ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤.", usage: "VStack {\n    Text('Hello')\n    Text('World')\n}", attr: ["alignment: ì •ë ¬", "spacing: ê°„ê²©"] },
            "swift_text": { title: "Text", desc: "í™”ë©´ì— í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•˜ëŠ” ë·°ì…ë‹ˆë‹¤.", usage: "Text('ì•ˆë…•í•˜ì„¸ìš”').font(.title)", attr: [] },

            // Android (Kotlin) Keys
            "kotlin_fun": { title: "fun (í•¨ìˆ˜)", desc: "Kotlinì—ì„œ í•¨ìˆ˜ë¥¼ ì„ ì–¸í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í‚¤ì›Œë“œì…ë‹ˆë‹¤.", usage: "fun main() {\n    println('Hello')\n}", attr: [] },
            "kotlin_val": { title: "val (ì½ê¸° ì „ìš© ë³€ìˆ˜)", desc: "ê°’ì´ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ë³€ìˆ˜(Immutable)ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤. Javaì˜ finalê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤.", usage: "val name = 'Android'", attr: [] },
            "kotlin_var": { title: "var (ê°€ë³€ ë³€ìˆ˜)", desc: "ê°’ì„ ë‚˜ì¤‘ì— ë³€ê²½í•  ìˆ˜ ìˆëŠ” ë³€ìˆ˜(Mutable)ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤.", usage: "var count = 0\ncount = 1", attr: [] },
            "kotlin_class": { title: "class", desc: "ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ í‹€(í´ë˜ìŠ¤)ì„ ì •ì˜í•©ë‹ˆë‹¤.", usage: "class MainActivity : AppCompatActivity() {\n    ...\n}", attr: [] },
            "kotlin_println": { title: "println()", desc: "ë¡œê·¸ë‚˜ ì½˜ì†”ì— í…ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•˜ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.", usage: "println('Debug Message')", attr: [] }
        };

        let currentLang = 'html';
        let pyodide = null; // Pyodide instance
        
        // --- File Attachment Data ---
        let attachedFiles = {}; // { filename: { url: blobUrl, content: arrayBuffer } }

        // Initialize CodeMirror for Pane 1
        const editor1 = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
            mode: "htmlmixed",
            theme: "material-darker",
            lineNumbers: true,
            lineWrapping: true,
            styleActiveLine: true,
            matchTags: {bothTags: true},
            autoCloseBrackets: true,
            indentUnit: 4
        });
        editor1.setValue(templates.html);

        // Initialize CodeMirror for Pane 3
        const editor3 = CodeMirror.fromTextArea(document.getElementById("blockEditor"), {
            mode: "htmlmixed",
            theme: "material-darker",
            lineNumbers: true,
            lineWrapping: true,
            indentUnit: 4
        });

        // Initialize Split.js
        Split(['#left-col', '#right-col'], { sizes: [50, 50], minSize: 100, gutterSize: 8 });
        Split(['#pane1', '#pane3'], { sizes: [75, 25], direction: 'vertical', minSize: 60, gutterSize: 8 });
        Split(['#pane2', '#pane4'], { sizes: [75, 25], direction: 'vertical', minSize: 60, gutterSize: 8 });

        // --- 2. Live Preview & Multi-Language Logic ---

        async function loadPyodideEngine() {
            if (pyodide) return;
            document.getElementById('status-indicator').textContent = "Loading Python...";
            try {
                pyodide = await loadPyodide();
                document.getElementById('status-indicator').textContent = "Python Ready";
                updatePreview(); 
            } catch (err) {
                console.error(err);
                document.getElementById('status-indicator').textContent = "Python Load Failed";
            }
        }

        function changeLanguage() {
            const select = document.getElementById('langSelect');
            currentLang = select.value;
            
            // 1. Update Editor Mode & Template
            if (currentLang === 'html') {
                editor1.setOption("mode", "htmlmixed");
                document.getElementById("editor-title").innerText = "EDITOR (HTML/CSS/JS)";
                editor1.setValue(templates.html);
            } else if (currentLang === 'python') {
                editor1.setOption("mode", "python");
                document.getElementById("editor-title").innerText = "EDITOR (PYTHON)";
                editor1.setValue(templates.python);
                loadPyodideEngine(); 
            } else if (currentLang === 'ios') {
                editor1.setOption("mode", "swift");
                document.getElementById("editor-title").innerText = "EDITOR (SWIFT/iOS)";
                editor1.setValue(templates.ios);
            } else if (currentLang === 'android') {
                editor1.setOption("mode", "text/x-java"); 
                document.getElementById("editor-title").innerText = "EDITOR (KOTLIN/ANDROID)";
                editor1.setValue(templates.android);
            }

            // 2. Update Preview Visibility
            togglePreviewPanes();
            updatePreview();
        }

        function togglePreviewPanes() {
            const frame = document.getElementById('previewFrame');
            const consoleDiv = document.getElementById('consoleOutput');
            const mobileDiv = document.getElementById('mobilePreview');

            frame.style.display = 'none';
            consoleDiv.style.display = 'none';
            mobileDiv.style.display = 'none';
            mobileDiv.classList.remove('flex'); 

            if (currentLang === 'html') {
                frame.style.display = 'block';
            } else if (currentLang === 'python') {
                consoleDiv.style.display = 'block';
            } else {
                mobileDiv.style.display = 'flex'; 
            }
        }

        // --- File Upload Logic ---
        function handleFileUpload(input) {
            const files = input.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create Blob URL for HTML/Preview
                    const blob = new Blob([e.target.result], {type: file.type});
                    const url = URL.createObjectURL(blob);
                    
                    // Store File Info (ArrayBuffer for Python)
                    attachedFiles[file.name] = {
                        url: url,
                        content: new Uint8Array(e.target.result)
                    };
                    
                    updateFileListUI();
                    
                    // Update preview to reflect new file availability
                    updatePreview();
                };
                reader.readAsArrayBuffer(file);
            });
            input.value = ''; // Reset input
        }

        // Helper function to force refresh editors
        function refreshEditors() {
            setTimeout(() => {
                editor1.refresh();
                editor3.refresh();
            }, 50);
        }

        function updateFileListUI() {
            const container = document.getElementById('attachedFilesList');
            container.innerHTML = '';
            
            Object.keys(attachedFiles).forEach(filename => {
                const badge = document.createElement('div');
                badge.className = "bg-blue-900 text-blue-100 text-xs px-2 py-1 rounded flex items-center gap-1 border border-blue-700";
                badge.innerHTML = `
                    <span>ğŸ“„ ${filename}</span>
                    <button onclick="removeFile('${filename}')" class="text-blue-300 hover:text-white font-bold ml-1">Ã—</button>
                `;
                container.appendChild(badge);
            });
            
            // FIX: Refresh editor layout immediately and after animation
            editor1.refresh();
            editor3.refresh();
            setTimeout(() => {
                editor1.refresh();
                editor3.refresh();
            }, 350);
        }

        function removeFile(filename) {
            if (attachedFiles[filename]) {
                URL.revokeObjectURL(attachedFiles[filename].url); // Memory cleanup
                delete attachedFiles[filename];
                updateFileListUI();
                updatePreview();
                
                // If Python, we should also remove from Pyodide FS if possible
                if (pyodide && currentLang === 'python') {
                    try { pyodide.FS.unlink(filename); } catch(e) {}
                }
            }
        }

        let isTempPreview = false;

        async function updatePreview(customCode = null) {
            let code = customCode !== null ? customCode : editor1.getValue();
            
            if (currentLang === 'html') {
                // --- HTML: Inject Attached Files ---
                // Replace "filename.ext" in src/href with Blob URL
                // Simple regex replacement: looks for src="filename" or href="filename"
                Object.keys(attachedFiles).forEach(filename => {
                    const blobUrl = attachedFiles[filename].url;
                    // Regex to safely replace filename inside quotes for src or href
                    // Handles src="file.png", src='file.png', href="file.css" etc.
                    const regex = new RegExp(`(src|href)=["']${filename.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']`, 'g');
                    code = code.replace(regex, `$1="${blobUrl}"`);
                });

                const previewFrame = document.getElementById('previewFrame');
                const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                doc.open();
                doc.write(code);
                doc.close();
            } 
            else if (currentLang === 'python') {
                const outputDiv = document.getElementById('consoleOutput');
                outputDiv.innerText = "Running...";
                
                if (!pyodide) {
                    outputDiv.innerText = "Initializing Python Environment... (Please wait)";
                    return;
                }

                try {
                    // --- Python: Write Attached Files to Virtual FS ---
                    Object.keys(attachedFiles).forEach(filename => {
                        const content = attachedFiles[filename].content;
                        pyodide.FS.writeFile(filename, content);
                    });

                    pyodide.setStdout({ batched: (msg) => {
                        if(outputDiv.innerText === "Running...") outputDiv.innerText = "";
                        outputDiv.innerText += msg + "\n";
                    }});

                    await pyodide.runPythonAsync(code);
                } catch (err) {
                    outputDiv.innerText = "Error:\n" + err;
                }
            }
            else if (currentLang === 'ios' || currentLang === 'android') {
                const mobileScreen = document.getElementById('mobileScreenContent');
                const title = currentLang === 'ios' ? 'iOS App' : 'Android App';
                const color = currentLang === 'ios' ? 'text-blue-600' : 'text-green-600';
                
                let displayText = "Hello World";
                const match = code.match(/"([^"]*)"/); 
                if (match) displayText = match[1];

                mobileScreen.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="mb-4 text-4xl ${color}">
                            ${currentLang === 'ios' ? 'ï£¿' : 'ğŸ¤–'}
                        </div>
                        <h1 class="text-xl font-bold">${title}</h1>
                        <p class="text-gray-600 mb-4">Preview Simulation</p>
                        
                        <div class="bg-gray-100 p-4 rounded w-full text-left mb-4 shadow-sm border">
                            <p class="font-bold text-xs text-gray-500 mb-1">UI Render:</p>
                            <p class="text-lg">${displayText}</p>
                        </div>

                        <button onclick="alert('In a real app, this triggers logic!')">
                            Simulated Button
                        </button>

                        <div class="mt-8 text-xs text-gray-400">
                            * Native Compilation not available in browser.
                            <br>Code syntax is valid.
                        </div>
                    </div>
                `;
            }
        }

        let timeout = null;
        editor1.on("change", () => {
            if (currentLang === 'python') {
                if (timeout) clearTimeout(timeout);
                timeout = setTimeout(() => updatePreview(), 800); 
            } else {
                updatePreview();
            }
        });
        
        updatePreview();


        // --- 3. Pane 3 & 4: Block Detection & Explanation ---
        
        let currentBlockRange = null;

        editor1.on("cursorActivity", () => {
            const cursor = editor1.getCursor();
            document.getElementById('cursor-pos').textContent = `Line ${cursor.line + 1}, Col ${cursor.ch + 1}`;
            detectAndShowBlock(cursor);
        });

        function detectAndShowBlock(cursor) {
            const token = editor1.getTokenAt(cursor);
            const modeName = editor1.getMode().name;
            const lineContent = editor1.getLine(cursor.line).trim();
            
            let range = null;
            let type = modeName;
            
            if (modeName === "htmlmixed" || modeName === "xml") {
                 range = { from: {line: cursor.line, ch: 0}, to: {line: cursor.line, ch: editor1.getLine(cursor.line).length} };
                 type = "HTML/XML";
            } else {
                range = findEnclosingBraces(cursor) || { 
                    from: {line: cursor.line, ch: 0}, 
                    to: {line: cursor.line, ch: editor1.getLine(cursor.line).length} 
                };
            }

            if (!currentBlockRange || 
                range.from.line !== currentBlockRange.from.line || 
                range.to.line !== currentBlockRange.to.line) {
                
                currentBlockRange = range;
                const blockCode = editor1.getRange(range.from, range.to);
                editor3.setValue(blockCode);
                
                updateExplanation(type, blockCode, lineContent);
            }
        }

        function findEnclosingBraces(cursor) {
            const doc = editor1.getDoc();
            let openBracePos = null;
            for (let i = cursor.line; i >= Math.max(0, cursor.line - 500); i--) {
                const text = doc.getLine(i);
                const ch = text.lastIndexOf('{'); 
                if (ch !== -1) {
                    openBracePos = { line: i, ch: ch };
                    break;
                }
            }
            if (!openBracePos) return null;
            return findBalancedClosingBrace(openBracePos, openBracePos.line);
        }

        function findBalancedClosingBrace(openBracePos, startLineToReturn) {
             const doc = editor1.getDoc();
             let balance = 1;
             for (let i = openBracePos.line; i < doc.lineCount(); i++) {
                let text = doc.getLine(i);
                let startCh = (i === openBracePos.line) ? openBracePos.ch + 1 : 0;
                for (let j = startCh; j < text.length; j++) {
                    const char = text[j];
                    if (char === '{') balance++;
                    else if (char === '}') {
                        balance--;
                        if (balance === 0) {
                            return { from: { line: startLineToReturn, ch: 0 }, to: { line: i, ch: j + 1 } };
                        }
                    }
                }
             }
             return null;
        }

        function updateExplanation(type, codeSnippet, lineContent) {
            const expl = document.getElementById('explanationContent');
            let key = "default";
            let dynamicData = null;
            
            const lowerLine = lineContent.toLowerCase();
            const lowerCode = codeSnippet.toLowerCase();

            if (currentLang === 'html') {
                const match = lowerCode.match(/<([a-z0-9]+)/);
                if (match && syntaxData[match[1]]) key = match[1];
                else if (lowerCode.includes("function")) key = "function";
                else if (lowerCode.includes("var") || lowerCode.includes("let") || lowerCode.includes("const")) key = "var";
                
            } else if (currentLang === 'python') {
                if (lowerLine.startsWith("def ")) key = "python_def";
                else if (lowerLine.includes("print(")) key = "python_print";
                else if (lowerLine.startsWith("import ") || lowerLine.startsWith("from ")) key = "python_import";
                else if (lowerLine.startsWith("if ") || lowerLine.startsWith("elif ") || lowerLine.startsWith("else:")) key = "python_if";
                else if (lowerLine.startsWith("for ")) key = "python_for";
                
                if (key === "default") {
                     dynamicData = {
                        title: "Python Code",
                        desc: "íŒŒì´ì¬ ì‹¤í–‰ ì½”ë“œì…ë‹ˆë‹¤. ì„ íƒëœ ë¸”ë¡ì„ ë¶„ì„í•©ë‹ˆë‹¤.",
                        usage: codeSnippet.substring(0, 50) + "...",
                        attr: []
                    };
                }

            } else if (currentLang === 'ios') {
                if (lowerLine.includes("struct ")) key = "swift_struct";
                else if (lowerLine.includes("var ")) key = "swift_var";
                else if (lowerLine.includes("let ")) key = "swift_let";
                else if (lowerLine.includes("func ")) key = "swift_func";
                else if (lowerLine.includes("vstack")) key = "swift_vstack";
                else if (lowerLine.includes("text(")) key = "swift_text";

                 if (key === "default") {
                     dynamicData = {
                        title: "Swift Code",
                        desc: "iOS ì•± ê°œë°œì„ ìœ„í•œ Swift ì½”ë“œì…ë‹ˆë‹¤.",
                        usage: codeSnippet.substring(0, 50) + "...",
                        attr: []
                    };
                }

            } else if (currentLang === 'android') {
                if (lowerLine.includes("fun ")) key = "kotlin_fun";
                else if (lowerLine.includes("val ")) key = "kotlin_val";
                else if (lowerLine.includes("var ")) key = "kotlin_var";
                else if (lowerLine.includes("class ")) key = "kotlin_class";
                else if (lowerLine.includes("println")) key = "kotlin_println";

                 if (key === "default") {
                     dynamicData = {
                        title: "Kotlin Code",
                        desc: "Android ì•± ê°œë°œì„ ìœ„í•œ Kotlin ì½”ë“œì…ë‹ˆë‹¤.",
                        usage: codeSnippet.substring(0, 50) + "...",
                        attr: []
                    };
                }
            }

            const data = dynamicData || syntaxData[key] || syntaxData["default"];

            let attrHtml = "";
            if (data.attr && data.attr.length > 0) {
                attrHtml = `<div class="mt-3">
                    <p class="font-bold text-xs text-gray-500 mb-1">ì£¼ìš” ì†ì„±/íŠ¹ì§•:</p>
                    <ul class="list-disc list-inside text-xs text-gray-700 space-y-1 bg-gray-100 p-2 rounded">
                        ${data.attr.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                </div>`;
            }

            expl.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-bold text-blue-600 flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded border border-blue-200">${currentLang.toUpperCase()}</span>
                            ${data.title}
                        </h3>
                        <p class="text-sm text-gray-700 mt-2 leading-relaxed border-l-4 border-blue-400 pl-3 bg-blue-50 py-2 pr-2 rounded-r">
                            ${data.desc}
                        </p>
                    </div>

                    <div>
                        <p class="font-bold text-xs text-gray-500 mb-1">ì‚¬ìš©ë²• (Syntax):</p>
                        <pre class="bg-[#282c34] text-gray-300 p-3 rounded text-xs font-mono overflow-x-auto border border-gray-600"><code>${escapeHtml(data.usage)}</code></pre>
                    </div>
                    
                    ${attrHtml}
                </div>
            `;
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }


        // --- 4. Search Functionality (Updated for Highlight) ---
        let searchCursor = null;
        let searchMarks = []; // Store highlight marks

        function performSearch(next) {
            const query = document.getElementById('searchInput').value;
            
            // Clear previous marks
            searchMarks.forEach(mark => mark.clear());
            searchMarks = [];

            if (!query) return;

            // 1. Highlight ALL matches first (High Contrast)
            const cursor = editor1.getSearchCursor(query);
            while (cursor.findNext()) {
                const mark = editor1.markText(cursor.from(), cursor.to(), { className: "search-highlight" });
                searchMarks.push(mark);
            }

            // 2. Navigation logic (Find Next/Prev)
            if (!searchCursor || searchCursor.query !== query) {
                searchCursor = editor1.getSearchCursor(query);
                searchCursor.query = query;
            }

            let found;
            if (next) {
                found = searchCursor.findNext();
                if (!found) { 
                    searchCursor = editor1.getSearchCursor(query); // Wrap
                    searchCursor.query = query;
                    found = searchCursor.findNext();
                }
            } else {
                found = searchCursor.findPrevious();
                if (!found) {
                    searchCursor = editor1.getSearchCursor(query, {line: editor1.lineCount(), ch: 0}); // Wrap
                    searchCursor.query = query;
                    found = searchCursor.findPrevious();
                }
            }

            if (found) {
                // Select and scroll to the specific match
                editor1.setSelection(searchCursor.from(), searchCursor.to());
                editor1.scrollIntoView(searchCursor.from(), 200);
                editor1.focus();
                
                // Show count
                document.getElementById('searchCount').textContent = `${searchMarks.length}`;
            } else {
                showToast("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
        }


        // --- 5. Button Actions ---

        function clearEditor() {
            if(confirm("ëª¨ë“  ì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                editor1.setValue("");
                showToast("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                refreshEditors(); // Added
            }
        }

        function saveFile() {
            const code = editor1.getValue();
            const ext = currentLang === 'python' ? 'py' : (currentLang === 'html' ? 'html' : (currentLang === 'ios' ? 'swift' : 'kt'));
            const filename = `code_${Date.now()}.${ext}`;
            const blob = new Blob([code], {type: "text/plain"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            showToast(`ì €ì¥ì™„ë£Œ: ${filename}`);
        }

        function formatCode() {
            try {
                const currentCode = editor1.getValue();
                let formatted = currentCode;
                
                if (currentLang === 'html') {
                    formatted = prettier.format(currentCode, { parser: "html", plugins: prettierPlugins, tabWidth: 4 });
                } else if (currentLang === 'python') {
                    showToast("Python ì •ë ¬ì€ í˜„ì¬ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); 
                    return;
                }
                
                editor1.setValue(formatted);
                showToast("ì½”ë“œê°€ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
                showToast("ì½”ë“œ ì •ë ¬ ì‹¤íŒ¨: ë¬¸ë²• ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        function testBlock() {
            if (!currentBlockRange) return;
            const pane3Content = editor3.getValue();
            const fullCode = editor1.getValue();
            const doc = new CodeMirror.Doc(fullCode, editor1.getOption("mode"));
            doc.replaceRange(pane3Content, currentBlockRange.from, currentBlockRange.to);
            const tempCode = doc.getValue();
            updatePreview(tempCode);
            isTempPreview = true;
            showToast("ë¯¸ë¦¬ë³´ê¸°ì— ì„ì‹œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function applyBlock() {
            if (!currentBlockRange) return;
            if (confirm("ì›ë³¸ ì½”ë“œì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const newContent = editor3.getValue();
                editor1.replaceRange(newContent, currentBlockRange.from, currentBlockRange.to);
                showToast("ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('translate-y-20');
            setTimeout(() => { toast.classList.add('translate-y-20'); }, 3000);
        }

        document.addEventListener('mousedown', (e) => {
            if (isTempPreview) {
                const pane3 = document.getElementById('pane3');
                if (pane3 && !pane3.contains(e.target)) {
                    updatePreview();
                    showToast("ë¯¸ë¦¬ë³´ê¸°ê°€ ì›ë³¸ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }
        });

        // Window resize listener to refresh editors
        window.addEventListener('resize', refreshEditors);

        // --- 6. AI Assistant Functions ---
        
        function toggleAIChat() {
            const chat = document.getElementById('aiChatContainer');
            if (chat.style.display === 'flex') {
                chat.style.display = 'none';
            } else {
                chat.style.display = 'flex';
                // Load API Key if exists
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) {
                    document.getElementById('geminiApiKey').value = savedKey;
                    document.getElementById('apiKeySection').style.display = 'none'; // Hide if key exists
                }
            }
        }

        function saveApiKey() {
            const key = document.getElementById('geminiApiKey').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('apiKeySection').style.display = 'none';
                showToast("API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                showToast("API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }

        async function sendMessageToAI() {
            const inputField = document.getElementById('aiUserQuery');
            const userQuery = inputField.value.trim();
            const apiKey = localStorage.getItem('gemini_api_key');

            if (!userQuery) return;
            if (!apiKey) {
                alert("Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                document.getElementById('apiKeySection').style.display = 'block';
                return;
            }

            // UI Update: Add User Message
            addMessageToChat(userQuery, 'user');
            inputField.value = '';

            // Show Loading
            const loadingId = addMessageToChat('<div class="loader"></div>', 'bot');

            // Prepare Prompt
            const currentCode = editor1.getValue();
            const systemPrompt = `You are an expert coding assistant. The user is writing code in ${currentLang.toUpperCase()}. 
            Current Code:
            \`\`\`${currentLang}
            ${currentCode}
            \`\`\`
            User Query: ${userQuery}
            
            Please provide concise advice or corrected code. If you provide code, wrap it in markdown code blocks.`;

            // Call API
            try {
                // ëª¨ë¸ëª… ì—…ë°ì´íŠ¸: gemini-2.5-flash (ì‚¬ìš©ì ìš”ì²­ ëª¨ë¸ ì ìš©)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }]
                    })
                });

                const data = await response.json();
                
                // Remove Loader
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();

                // Error Handling Improvements
                if (!response.ok) {
                    let errorMsg = "API í˜¸ì¶œ ì˜¤ë¥˜";
                    if (data.error && data.error.message) {
                        errorMsg += `: ${data.error.message}`;
                    } else {
                        errorMsg += ` (${response.status})`;
                    }
                    addMessageToChat(errorMsg, 'bot');
                    console.error("Gemini API Error:", data);
                    return;
                }

                if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    const msgId = addMessageToChat(marked.parse(aiText), 'bot');
                    
                    // Add Copy/Apply buttons to code blocks
                    const msgDiv = document.getElementById(msgId);
                    if (msgDiv) addCodeButtons(msgDiv);
                    
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    addMessageToChat(`ì•ˆì „ ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìœ : ${data.promptFeedback.blockReason}`, 'bot');
                } else {
                    addMessageToChat("ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‘ë‹µ ì—†ìŒ)", 'bot');
                    console.error(data);
                }

            } catch (error) {
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                addMessageToChat(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'bot');
                console.error(error);
            }
        }

        function addMessageToChat(htmlContent, sender) {
            const container = document.getElementById('aiChatMessages');
            const msgDiv = document.createElement('div');
            const id = 'msg-' + Date.now();
            msgDiv.id = id;
            msgDiv.className = `ai-msg ${sender}`;
            msgDiv.innerHTML = htmlContent;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            return id;
        }
        
        // Add Copy and Apply buttons to code blocks in AI messages
        function addCodeButtons(msgDiv) {
            const preTags = msgDiv.querySelectorAll('pre');
            preTags.forEach(pre => {
                // Check if already processed
                if (pre.querySelector('.code-block-header')) return;
                
                // Extract raw code
                const code = pre.querySelector('code') ? pre.querySelector('code').innerText : pre.innerText;
                
                // Create header
                const header = document.createElement('div');
                header.className = 'code-block-header';
                
                // Copy Button
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-btn';
                copyBtn.textContent = 'ë³µì‚¬';
                copyBtn.onclick = () => copyCode(code);
                
                // Apply Button
                const applyBtn = document.createElement('button');
                applyBtn.className = 'code-btn apply';
                applyBtn.textContent = 'ì ìš©';
                applyBtn.onclick = () => applyCode(code);
                
                header.appendChild(copyBtn);
                header.appendChild(applyBtn);
                
                // Insert header before code content
                pre.insertBefore(header, pre.firstChild);
            });
        }
        
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast("ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }).catch(err => {
                showToast("ë³µì‚¬ ì‹¤íŒ¨: " + err);
            });
        }
        
        function applyCode(code) {
            if (confirm("í˜„ì¬ ì—ë””í„°ì˜ ë‚´ìš©ì„ ì´ ì½”ë“œë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                editor1.setValue(code);
                showToast("ì½”ë“œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        // Enable Enter to send
        document.getElementById('aiUserQuery').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageToAI();
            }
        });

        // Draggable Chat Window
        const chatHeader = document.getElementById('aiChatHeader');
        const chatContainer = document.getElementById('aiChatContainer');
        let isDragging = false;
        let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

        chatHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
            if (e.target === chatHeader || e.target.parentNode === chatHeader) {
                isDragging = true;
            }
        }
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, chatContainer);
            }
        }
        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
        }
        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }

    </script>
</body>
</html>
